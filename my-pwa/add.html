<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>试卷智能分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --accent-color: #9b59b6;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
            margin: 20px auto;
            max-width: 1200px;
        }
        
        .card-header {
            border-radius: 15px 15px 0 0 !important;
            background: linear-gradient(135deg, var(--primary-color) 0%, #2980b9 100%);
        }
        
        .step-section {
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
            background: white;
        }
        
        .step-section:last-child {
            border-bottom: none;
        }
        
        .step-title {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-indicator {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-analyzing { background: var(--primary-color); color: white; }
        .status-completed { background: var(--secondary-color); color: white; }
        .status-error { background: #e74c3c; color: white; }
        
        .question-card {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            background: var(--light-bg);
            transition: all 0.3s;
        }
        
        .question-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .question-content {
            line-height: 1.6;
            white-space: pre-wrap;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .badge-type {
            background: var(--accent-color);
        }
        
        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s;
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.3);
            color: white;
            text-decoration: none;
        }
        
        .form-control, .btn {
            border-radius: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #2980b9 100%);
            border: none;
            padding: 10px 25px;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #27ae60 100%);
            border: none;
        }
        
        #questionsPreview {
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .api-key-group {
            position: relative;
        }
        
        .eye-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="ms-3 fw-bold" id="loadingText">正在处理...</div>
    </div>

    <div class="container-fluid py-4">
        <div class="main-card card">
            <div class="card-header text-white">
                <div class="nav-header">
                    <h4 class="mb-0"><i class="fas fa-file-alt"></i> 试卷智能分析系统</h4>
                    <a href="search.html" class="nav-link">
                        <i class="fas fa-search"></i> 前往搜索页面
                    </a>
                </div>
            </div>
            
            <div class="card-body p-0">
                <!-- 第一步：上传试卷 -->
                <div class="step-section">
                    <h5 class="step-title"><span class="badge bg-primary">1</span> 上传试卷文件</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">试卷名称 *</label>
                            <input type="text" class="form-control" id="examName" placeholder="例如：2024年高考语文模拟试卷">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">试卷描述</label>
                            <input type="text" class="form-control" id="examDescription" placeholder="例如：高三上学期期末考试">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label fw-bold">上传试卷文件 *</label>
                        <input type="file" class="form-control" id="examFile" accept=".docx,.txt,.pdf">
                        <small class="text-muted">支持格式：.docx, .txt, .pdf (推荐使用 .docx)</small>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label fw-bold">DeepSeek API Key *</label>
                        <div class="api-key-group">
                            <input type="password" class="form-control" id="apiKey" placeholder="输入您的 DeepSeek API Key">
                            <button class="eye-toggle" type="button" id="toggleApiKey">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted">
                            <a href="https://platform.deepseek.com/api_keys" target="_blank" class="text-decoration-none">
                                <i class="fas fa-key"></i> 获取 API Key
                            </a>
                        </small>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-primary" id="uploadBtn" onclick="uploadAndAnalyze()">
                            <i class="fas fa-upload"></i> 上传并开始分析
                        </button>
                        <button class="btn btn-outline-primary ms-2" onclick="toggleManualInput()">
                            <i class="fas fa-keyboard"></i> 手动输入试卷
                        </button>
                    </div>
                </div>
                
                <!-- 手动输入区域 -->
                <div class="step-section" id="manualInputSection" style="display: none;">
                    <h5 class="step-title"><i class="fas fa-edit"></i> 手动输入试卷内容</h5>
                    <textarea class="form-control" id="manualExamContent" rows="8" 
                              placeholder="请将试卷内容粘贴在这里..."></textarea>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="analyzeManualInput()">
                            <i class="fas fa-robot"></i> 开始分析
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="toggleManualInput()">
                            取消
                        </button>
                    </div>
                </div>
                
                <!-- 第二步：AI 分析进度 -->
                <div class="step-section" id="analysisSection" style="display: none;">
                    <h5 class="step-title"><span class="badge bg-primary">2</span> AI 分析进度</h5>
                    <div class="alert alert-info border-0" style="background: #e8f4fc;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong id="statusText">准备开始分析...</strong>
                                <div id="progressText" class="text-muted">正在初始化...</div>
                            </div>
                            <span class="status-indicator" id="statusIndicator">等待</span>
                        </div>
                    </div>
                    <div class="progress mb-3" style="height: 10px; border-radius: 5px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- 第三步：预览和编辑 -->
                <div class="step-section" id="previewSection" style="display: none;">
                    <h5 class="step-title"><span class="badge bg-primary">3</span> 预览和编辑题目</h5>
                    <div class="alert alert-warning border-0" style="background: #fff3cd;">
                        <i class="fas fa-info-circle"></i> 
                        AI 分析已完成，请检查以下题目信息。您可以编辑题目内容、修改类型和标签。
                    </div>
                    
                    <div id="questionsPreview"></div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <div>
                            <button class="btn btn-success" onclick="saveToDatabase()">
                                <i class="fas fa-check-circle"></i> 确认保存到数据库
                            </button>
                            <button class="btn btn-outline-danger ms-2" onclick="resetAll()">
                                <i class="fas fa-redo"></i> 重新开始
                            </button>
                        </div>
                        <div>
                            <span class="text-muted">共 <span id="totalQuestions" class="fw-bold">0</span> 个题目</span>
                        </div>
                    </div>
                </div>
                
                <!-- 第四步：保存结果 -->
                <div class="step-section" id="saveSection" style="display: none;">
                    <h5 class="step-title"><span class="badge bg-primary">4</span> 保存结果</h5>
                    <div class="alert alert-success border-0" id="saveResult" style="background: #d4edda;">
                        <!-- 保存结果会动态显示在这里 -->
                    </div>
                    <button class="btn btn-primary" onclick="resetAll()">
                        <i class="fas fa-plus-circle"></i> 分析新试卷
                    </button>
                    <a href="search.html" class="btn btn-outline-primary ms-2">
                        <i class="fas fa-database"></i> 查看数据库
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑题目模态框 -->
    <div class="modal fade" id="editQuestionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> 编辑题目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editQuestionIndex">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">题目内容</label>
                        <textarea class="form-control" id="editQuestionContent" rows="6"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">题目类型</label>
                        <select class="form-select" id="editQuestionType"></select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">题目标签</label>
                        <select class="form-select" id="editQuestionTags" multiple></select>
                        <small class="text-muted">按住 Ctrl 键可以多选</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveQuestionEdit()">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/mammoth@1.5.1/mammoth.browser.min.js"></script>
    
    <script src="js/ExamDatabase.js"></script>
    <script src="js/ExamAnalyzer.js"></script>
    
    <script>
        // 全局变量
        let currentAnalysisResult = null;
        let examDB = null;
        let analyzer = null;
        let questionTypes = [];
        let questionTags = [];
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                examDB = ExamDatabase.getInstance();
                await examDB.init();
                console.log('数据库初始化成功');
                
                questionTypes = await examDB.getAllQuestionTypes();
                questionTags = await examDB.getAllTags();
                
                // API Key 显示/隐藏切换
                document.getElementById('toggleApiKey').addEventListener('click', function() {
                    const apiKeyInput = document.getElementById('apiKey');
                    const icon = this.querySelector('i');
                    if (apiKeyInput.type === 'password') {
                        apiKeyInput.type = 'text';
                        icon.className = 'far fa-eye-slash';
                    } else {
                        apiKeyInput.type = 'password';
                        icon.className = 'far fa-eye';
                    }
                });
            } catch (error) {
                console.error('初始化失败:', error);
                alert('初始化失败: ' + error.message);
            }
        });
        
        // 加载动画
        function showLoading(text = '正在处理...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function showError(message) {
            hideLoading();
            alert('错误: ' + message);
        }
        
        // 更新进度
        function updateProgress(percent, status, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('statusText').textContent = status;
            document.getElementById('progressText').textContent = text;
            
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = status;
            indicator.className = 'status-indicator';
            
            if (percent < 100) {
                indicator.classList.add('status-analyzing');
            } else {
                indicator.classList.add('status-completed');
            }
        }
        
        // 手动输入切换
        function toggleManualInput() {
            const manualSection = document.getElementById('manualInputSection');
            const examFile = document.getElementById('examFile');
            const isVisible = manualSection.style.display === 'block';
            
            manualSection.style.display = isVisible ? 'none' : 'block';
            examFile.disabled = !isVisible;
            
            if (!isVisible) {
                document.getElementById('manualExamContent').value = '';
            }
        }
        
        // 上传并分析试卷
        async function uploadAndAnalyze() {
            const examName = document.getElementById('examName').value.trim();
            const examFile = document.getElementById('examFile').files[0];
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!examName) return alert('请输入试卷名称');
            if (!examFile) return alert('请选择试卷文件');
            if (!apiKey) return alert('请输入 DeepSeek API Key');
            
            try {
                showLoading('正在读取文件...');
                const fileContent = await readFileContent(examFile);
                await startAnalysis(examName, fileContent, apiKey);
            } catch (error) {
                showError('处理失败: ' + error.message);
            }
        }
        
        // 读取文件内容
        async function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        if (file.name.endsWith('.txt')) {
                            resolve(e.target.result);
                        } else if (file.name.endsWith('.docx')) {
                            const result = await mammoth.extractRawText({arrayBuffer: e.target.result});
                            resolve(result.value);
                        } else if (file.name.endsWith('.pdf')) {
                            alert('PDF文件内容提取有限，建议使用.docx或.txt文件');
                            resolve('PDF文件需要专门的解析库。建议将PDF内容复制粘贴到文本框中。');
                        } else {
                            throw new Error('不支持的文件格式');
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('文件读取失败'));
                
                if (file.name.endsWith('.docx')) {
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.readAsText(file);
                }
            });
        }
        
        // 分析手动输入的试卷
        async function analyzeManualInput() {
            const examName = document.getElementById('examName').value.trim();
            const examContent = document.getElementById('manualExamContent').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!examName) return alert('请输入试卷名称');
            if (!examContent) return alert('请输入试卷内容');
            if (!apiKey) return alert('请输入 DeepSeek API Key');
            
            await startAnalysis(examName, examContent, apiKey);
        }
        
        // 开始分析流程
        async function startAnalysis(examName, examContent, apiKey) {
            try {
                document.getElementById('analysisSection').style.display = 'block';
                updateProgress(10, '初始化', '正在初始化分析器...');
                
                analyzer = new ExamAnalyzer(apiKey);
                await analyzer.initialize();
                
                updateProgress(30, '分析中', '正在调用AI分析试卷内容...');
                const analysisResult = await analyzer.analyzeExamWithDeepSeek(examContent);
                
                updateProgress(80, '处理结果', '正在整理分析结果...');
                
                currentAnalysisResult = {
                    examName: examName,
                    examDescription: document.getElementById('examDescription').value.trim(),
                    analysis: analysisResult,
                    timestamp: new Date().toISOString()
                };
                
                updateProgress(100, '完成', '分析完成！');
                
                setTimeout(() => {
                    document.getElementById('analysisSection').style.display = 'none';
                    showPreview(analysisResult);
                }, 1000);
                
            } catch (error) {
                console.error('分析失败:', error);
                document.getElementById('statusIndicator').className = 'status-indicator status-error';
                showError('AI分析失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 显示预览
        function showPreview(analysisResult) {
            const previewSection = document.getElementById('previewSection');
            const questionsPreview = document.getElementById('questionsPreview');
            
            document.getElementById('totalQuestions').textContent = analysisResult.questions.length;
            questionsPreview.innerHTML = '';
            
            analysisResult.questions.forEach((question, index) => {
                const type = questionTypes.find(t => t.id === question.type_id);
                const typeName = type ? type.content : '未知类型';
                
                let tagsHtml = '';
                if (question.tag_ids && question.tag_ids.length > 0) {
                    question.tag_ids.forEach(tagId => {
                        const tag = questionTags.find(t => t.id === tagId);
                        if (tag) {
                            tagsHtml += `<span class="badge bg-info me-1">${tag.content}</span>`;
                        }
                    });
                }
                
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-card position-relative';
                questionDiv.innerHTML = `
                    <button class="btn btn-sm btn-outline-primary position-absolute top-0 end-0" 
                            onclick="editQuestion(${index})">
                        <i class="fas fa-pencil-alt"></i> 编辑
                    </button>
                    <h6 class="fw-bold mb-3">题目 ${index + 1}</h6>
                    <div class="question-content mb-3">${escapeHtml(question.content)}</div>
                    <div class="d-flex flex-wrap gap-3">
                        <div>
                            <span class="fw-bold me-2">类型:</span>
                            <span class="badge badge-type">${typeName}</span>
                        </div>
                        <div>
                            <span class="fw-bold me-2">标签:</span>
                            ${tagsHtml || '<span class="text-muted">无标签</span>'}
                        </div>
                    </div>
                `;
                questionsPreview.appendChild(questionDiv);
            });
            
            previewSection.style.display = 'block';
        }
        
        // 编辑题目
        function editQuestion(index) {
            const question = currentAnalysisResult.analysis.questions[index];
            document.getElementById('editQuestionIndex').value = index;
            document.getElementById('editQuestionContent').value = question.content;
            
            const typeSelect = document.getElementById('editQuestionType');
            typeSelect.innerHTML = '<option value="">选择题目类型</option>';
            questionTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.content;
                if (type.id === question.type_id) option.selected = true;
                typeSelect.appendChild(option);
            });
            
            const tagSelect = document.getElementById('editQuestionTags');
            tagSelect.innerHTML = '';
            const availableTags = questionTags.filter(tag => tag.type_id === question.type_id);
            availableTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.id;
                option.textContent = tag.content;
                if (question.tag_ids && question.tag_ids.includes(tag.id)) option.selected = true;
                tagSelect.appendChild(option);
            });
            
            const modal = new bootstrap.Modal(document.getElementById('editQuestionModal'));
            modal.show();
            
            typeSelect.addEventListener('change', function() {
                const newTypeId = parseInt(this.value);
                updateAvailableTags(newTypeId);
            });
        }
        
        function updateAvailableTags(typeId) {
            const tagSelect = document.getElementById('editQuestionTags');
            tagSelect.innerHTML = '';
            
            const availableTags = questionTags.filter(tag => tag.type_id === typeId);
            availableTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.id;
                option.textContent = tag.content;
                tagSelect.appendChild(option);
            });
        }
        
        function saveQuestionEdit() {
            const index = parseInt(document.getElementById('editQuestionIndex').value);
            const content = document.getElementById('editQuestionContent').value.trim();
            const typeId = parseInt(document.getElementById('editQuestionType').value);
            const tagOptions = document.getElementById('editQuestionTags').selectedOptions;
            const tagIds = Array.from(tagOptions).map(option => parseInt(option.value));
            
            if (!content) return alert('题目内容不能为空');
            if (!typeId) return alert('请选择题目类型');
            
            currentAnalysisResult.analysis.questions[index].content = content;
            currentAnalysisResult.analysis.questions[index].type_id = typeId;
            currentAnalysisResult.analysis.questions[index].tag_ids = tagIds;
            
            bootstrap.Modal.getInstance(document.getElementById('editQuestionModal')).hide();
            showPreview(currentAnalysisResult.analysis);
        }
        
        // 保存到数据库
        async function saveToDatabase() {
            if (!currentAnalysisResult) return alert('没有可保存的数据');
            
            try {
                showLoading('正在保存到数据库...');
                
                const saveResult = await analyzer.saveAnalysisToDatabase(
                    currentAnalysisResult.examName,
                    currentAnalysisResult.analysis,
                    currentAnalysisResult.examDescription
                );
                
                const saveSection = document.getElementById('saveSection');
                const saveResultDiv = document.getElementById('saveResult');
                
                saveResultDiv.innerHTML = `
                    <h5><i class="fas fa-check-circle text-success"></i> 保存成功！</h5>
                    <div class="mt-3">
                        <p><strong>试卷名称：</strong>${currentAnalysisResult.examName}</p>
                        <p><strong>试卷ID：</strong>${saveResult.examId}</p>
                        <p><strong>题目数量：</strong>${saveResult.totalQuestions} 个</p>
                        <p><strong>保存时间：</strong>${new Date().toLocaleString()}</p>
                    </div>
                `;
                
                document.getElementById('previewSection').style.display = 'none';
                saveSection.style.display = 'block';
                
            } catch (error) {
                showError('保存到数据库失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 重置所有
        function resetAll() {
            document.getElementById('examName').value = '';
            document.getElementById('examDescription').value = '';
            document.getElementById('examFile').value = '';
            document.getElementById('apiKey').value = '';
            document.getElementById('manualExamContent').value = '';
            
            document.getElementById('manualInputSection').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('saveSection').style.display = 'none';
            
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('questionsPreview').innerHTML = '';
            
            currentAnalysisResult = null;
            analyzer = null;
            document.getElementById('examFile').disabled = false;
        }
        
        // HTML 转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }
        
        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's' && document.getElementById('previewSection').style.display === 'block') {
                e.preventDefault();
                saveToDatabase();
            }
            if (e.key === 'Escape' && document.getElementById('previewSection').style.display === 'block') {
                resetAll();
            }
        });
    </script>
</body>
</html>